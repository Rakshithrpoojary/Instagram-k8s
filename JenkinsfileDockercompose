pipeline{
    agent {label "jenkins-agent"}

environment{
    PORT=4000
    MONGO_URI = credentials('mongo-uri')
    JWT_SECRET = credentials('jwt-secret')
    JWT_EXPIRE = 7d
    COOKIE_EXPIRE = 5
    SENDGRID_API_KEY = credentials('sendgrid-api')
    SENDGRID_MAIL = credentials('sendgrid-mail')
    SENDGRID_RESET_TEMPLATEID = credentials('sendgrid-template-id')
    AWS_BUCKET_NAME = credentials('aws-bucket-name')
    AWS_BUCKET_REGION =credentials('aws-region')
    AWS_IAM_USER_KEY = credentials('access-key')
    AWS_IAM_USER_SECRET =credentials('secret-key')
    NODE_ENV ="production"
    AWS_DEFAULT_REGION="ap-south-1"
    AWS_REPO_FOR_FRONTEND = credentials('frontend-repo')
    REPOSITORY_URI_FOR_FRONTEND =credentials('frontend-repo-url')
    AWS_REPO_FOR_BACKEND =credentials('backend-repo')
    REPOSITORY_URI_FOR_BACKEND = credentials('backend-repo-url')
    REACT_APP_BACKEND_URL = credentials('backendurl')
}
    stages{
        stage("Checkout to git")
        {
            steps{
                git branch :"main",url:"https://github.com/Rakshithrpoojary/Instagram-k8s.git"
            }
        }
        stage("Build frontend image")
        {
            steps{
                dir("frontend")
                {
                sh "docker build --build-arg REACT_APP_BACKEND_URL=${REACT_APP_BACKEND_URL} -t ${AWS_REPO_FOR_FRONTEND} ."
                }
            }
        }
              stage("Build backend image")
        {
            steps{
                dir("backend")
                {
                sh "docker build  -t ${AWS_REPO_FOR_BACKEND} ."
                }
            }
        }
        stage("push to docker")
        {
            steps{
                sh 'aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${REPOSITORY_URI_FOR_FRONTEND}'
                sh 'aws ecr get-login-password --region ${AWS_DEFAULT_REGION} | docker login --username AWS --password-stdin ${REPOSITORY_URI_FOR_BACKEND}'
                sh 'docker tag ${AWS_REPO_FOR_FRONTEND} ${REPOSITORY_URI_FOR_FRONTEND}${AWS_REPO_FOR_FRONTEND}:${BUILD_NUMBER}'
                sh 'docker push ${REPOSITORY_URI_FOR_FRONTEND}${AWS_REPO_FOR_FRONTEND}:${BUILD_NUMBER}'
                sh 'docker tag ${AWS_REPO_FOR_BACKEND} ${REPOSITORY_URI_FOR_BACKEND}${AWS_REPO_FOR_BACKEND}:${BUILD_NUMBER}'
                sh 'docker push ${REPOSITORY_URI_FOR_BACKEND}${AWS_REPO_FOR_BACKEND}:${BUILD_NUMBER}'
            }
        }
        stage("Dockercompose")
        {
            steps{
                sh "docker compose down"
                sh "docker compose up -d"
            }
        }
    }
}